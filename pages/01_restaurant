import streamlit as st
import pandas as pd
import folium
from streamlit_folium import st_folium

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="ë§›ì§‘ íƒìƒ‰ê¸°", layout="wide")

st.title("ğŸ“ í–‰ì •êµ¬ì—­ë³„ ê³ í‰ì  ë§›ì§‘ íƒìƒ‰ê¸°")
st.markdown("êµ¬ê¸€ë§µ ë°ì´í„°(CSV)ë¥¼ ì—…ë¡œë“œí•˜ê³  í‰ì  4.5 ì´ìƒì˜ ë§›ì§‘ì„ í™•ì¸í•˜ì„¸ìš”.")

# 1. ë°ì´í„° ì—…ë¡œë“œ ê¸°ëŠ¥
uploaded_file = st.sidebar.file_uploader("ë§›ì§‘ ë°ì´í„° íŒŒì¼(CSV)ì„ ì—…ë¡œë“œí•˜ì„¸ìš”", type=["csv"])

if uploaded_file is not None:
    # ë°ì´í„° ë¡œë“œ (ê°€ì •: ì»¬ëŸ¼ëª… - ì‹ë‹¹ëª…, í–‰ì •êµ¬ì—­, í‰ì , ìœ„ë„, ê²½ë„, ì£¼ì†Œ, ìƒì„¸ì •ë³´)
    df = pd.read_csv(uploaded_file)
    
    # 2. í•„í„°ë§ ì‚¬ì´ë“œë°”
    st.sidebar.header("ğŸ” í•„í„° ì„¤ì •")
    
    # í–‰ì •êµ¬ì—­ ì„ íƒ
    regions = df['í–‰ì •êµ¬ì—­'].unique()
    selected_region = st.sidebar.selectbox("í–‰ì •êµ¬ì—­ ì„ íƒ", regions)
    
    # í‰ì  í•„í„° (ê¸°ë³¸ 4.5 ì´ìƒ)
    min_rating = st.sidebar.slider("ìµœì†Œ í‰ì  ì„ íƒ", 0.0, 5.0, 4.5)
    
    # ë°ì´í„° í•„í„°ë§ ì ìš©
    filtered_df = df[(df['í–‰ì •êµ¬ì—­'] == selected_region) & (df['í‰ì '] >= min_rating)]
    
    st.subheader(f"âœ… {selected_region} ì§€ì—­ - {min_rating}ì  ì´ìƒ ë§›ì§‘ ({len(filtered_df)}ê³³)")

    # 3. ì§€ë„ ìƒì„± (folium)
    if not filtered_df.empty:
        # ì§€ë„ì˜ ì¤‘ì‹¬ì ì„ í•„í„°ë§ëœ ë°ì´í„°ì˜ í‰ê·  ìœ„ê²½ë„ë¡œ ì„¤ì •
        center_lat = filtered_df['ìœ„ë„'].mean()
        center_lng = filtered_df['ê²½ë„'].mean()
        m = folium.Map(location=[center_lat, center_lng], zoom_start=13)

        for _, row in filtered_df.iterrows():
            # ë§ˆì»¤ ì¶”ê°€
            folium.Marker(
                location=[row['ìœ„ë„'], row['ê²½ë„']],
                # ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œ(Tooltip) í‰ì  í‘œì‹œ
                tooltip=f"â­ í‰ì : {row['í‰ì ']}",
                # í´ë¦­í–ˆì„ ë•Œ(Popup) ìƒì„¸ ì •ë³´ í‘œì‹œ
                popup=folium.Popup(f"""
                    <b>{row['ì‹ë‹¹ëª…']}</b><br>
                    ì£¼ì†Œ: {row['ì£¼ì†Œ']}<br>
                    í‰ì : {row['í‰ì ']}<br>
                    <p style='width:200px'>{row['ìƒì„¸ì •ë³´']}</p>
                """, max_width=300),
                icon=folium.Icon(color="red", icon="info-sign")
            ).add_to(m)

        # ì§€ë„ í‘œì‹œ
        st_folium(m, width=1000, height=600)
        
        # 4. ë°ì´í„°í”„ë ˆì„ ìƒì„¸ ë³´ê¸°
        st.write("### ğŸ“„ ë§›ì§‘ ìƒì„¸ ë¦¬ìŠ¤íŠ¸", filtered_df)
    else:
        st.warning("í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ë§›ì§‘ì´ ì—†ìŠµë‹ˆë‹¤.")

else:
    st.info("íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ì§€ë„ê°€ í™œì„±í™”ë©ë‹ˆë‹¤. CSV íŒŒì¼ì€ ì‹ë‹¹ëª…, í–‰ì •êµ¬ì—­, í‰ì , ìœ„ë„, ê²½ë„ ì»¬ëŸ¼ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.")
